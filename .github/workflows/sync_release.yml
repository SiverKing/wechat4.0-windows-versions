name: Sync Release from Upstream

on:
  workflow_dispatch:  # 允许手动触发
  schedule:
    - cron: '0 3 * * *'  # 每天凌晨 3 点 UTC 自动同步

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
    - name: Install GitHub CLI
      run: |
        sudo apt update
        sudo apt install gh -y

    - name: Get latest release info from upstream
      id: get_release
      run: |
        release_json=$(gh api repos/cscnk52/wechat-windows-versions/releases/latest)
        echo "$release_json" > release.json
        tag_name=$(echo "$release_json" | jq -r .tag_name)
        echo "tag=$tag_name" >> $GITHUB_OUTPUT
        echo "release_body=$(echo "$release_json" | jq -r .body)" >> $GITHUB_OUTPUT
      env:
        GH_TOKEN: ${{ secrets.GH_TOKEN }}

    - name: Download assets
      run: |
        mkdir assets
        for url in $(jq -r '.assets[].browser_download_url' release.json); do
          wget -P assets "$url"
        done

    - name: Recreate release in your repo
      run: |
        gh release delete "$TAG_NAME" -R SiverKing/wechat4.0-windows-versions -y || true
        gh release create "$TAG_NAME" assets/* \
          --repo SiverKing/wechat4.0-windows-versions \
          --title "$TAG_NAME" \
          --notes "${{ steps.get_release.outputs.release_body }}"
      env:
        GH_TOKEN: ${{ secrets.GH_TOKEN }}
        TAG_NAME: ${{ steps.get_release.outputs.tag }}
