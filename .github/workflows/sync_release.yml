name: Sync All Releases from Upstream

on:
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘ï¼ˆå»ºè®®é¦–æ¬¡æ‰‹åŠ¨è§¦å‘ï¼‰
  schedule:
    - cron: '0 3 * * *'  # æ¯å¤©å‡Œæ™¨åŒæ­¥ä¸€æ¬¡ï¼ˆå¯é€‰ï¼‰

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install gh jq wget -y

    - name: Fetch all releases from upstream
      run: |
        gh api repos/cscnk52/wechat-windows-versions/releases > all_releases.json
      env:
        GH_TOKEN: ${{ secrets.GH_TOKEN }}

    - name: Process each release
      run: |
        mkdir -p assets

        releases=$(jq -c '.[]' all_releases.json)

        echo "$releases" | while read -r release; do
          tag_name=$(echo "$release" | jq -r .tag_name)

          echo "ğŸ” Checking tag: $tag_name"

          # æ£€æŸ¥ä½ è‡ªå·±çš„ repo æ˜¯å¦å·²æœ‰è¯¥ release
          if gh release view "$tag_name" -R SiverKing/wechat4.0-windows-versions >/dev/null 2>&1; then
            echo "âœ… Release $tag_name already exists, skipping."
            continue
          fi

          echo "ğŸš€ Syncing release: $tag_name"

          # å†™ release body
          echo "$release" | jq -r .body > release_body.txt

          # æ¸…ç©º assets æ–‡ä»¶å¤¹
          rm -rf assets/*
          mkdir -p assets

          # ä¸‹è½½æ‰€æœ‰ assets
          for url in $(echo "$release" | jq -r '.assets[].browser_download_url'); do
            wget -q -P assets "$url"
          done

          # åˆ›å»º release
          gh release create "$tag_name" assets/* \
            --repo SiverKing/wechat4.0-windows-versions \
            --title "$tag_name" \
            --notes-file release_body.txt || echo "âš ï¸ Failed to create $tag_name"

          echo "âœ… Release $tag_name synced."

        done
      env:
        GH_TOKEN: ${{ secrets.GH_TOKEN }}
